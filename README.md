# でんさい通知XML テストデータ生成ツール

SAP S/4HANA 日本EMC関連（EMC_JP / RFFOJP_EMC）向けの、でんさい（densai.net）標準フォーマット通知XMLテストデータを生成するWebアプリケーションです。

**🌐 デモサイト**: [https://kmh-no3.github.io/emc-notice-genkit/](https://kmh-no3.github.io/emc-notice-genkit/)（GitHub Pages）  
**📦 リポジトリ**: [https://github.com/kmh-no3/emc-notice-genkit](https://github.com/kmh-no3/emc-notice-genkit)

> **GitHub Pages で公開するには**
> - **プッシュで自動ビルド・デプロイ**: **Settings** → **Pages** → **Source** を **「GitHub Actions」** に設定する。`main` へプッシュするとワークフローがテスト・ビルド・デプロイし、数分後に https://kmh-no3.github.io/emc-notice-genkit/ に反映される。
> - **手動デプロイ**: Source を **「Deploy from a branch」**、Branch を `gh-pages` にし、ローカルで `npm run deploy` を実行する。

## 概要

このツールは、でんさいネット標準フォーマット XML ver1.3 に準拠した `notice_ACR.ASG.DIV`（発生・譲渡通知）XMLを生成します。ブラウザ上で完結し、入力したデータは自動的にローカルストレージに保存されます。

## 主な機能

- ✅ でんさい通知XML（notice_ACR.ASG.DIV）の生成
- ✅ フォーム入力による簡単なデータ作成
- ✅ バリデーション機能（桁数、形式チェック）
- ✅ プリセットサンプルデータ（1件/複数件）
- ✅ XMLプレビュー機能
- ✅ XMLファイルダウンロード（UTF-8）
- ✅ ローカルストレージへの自動保存
- ✅ 依頼人Ref.No.の自動生成（BUKRS + BELNR + GJAHR）
- ✅ ダークモード対応

## UI・操作の流れ

ページ上部の**利用手順**は常に表示され、本ページの操作の流れをいつでも確認できます。

1. **① サンプル** … プリセットからサンプルデータを読み込む
2. **② データ入力** … ヘッダ情報・通知先情報・明細情報を入力
3. **③ XML生成** … 入力内容からXMLを生成
4. **④ ダウンロード** … 生成したXMLファイルをダウンロード

各手順の詳細（サンプル選択、データ入力フォーム、XML生成ボタン）は**アコーディオン**で開閉できます。見出しは利用手順と統一して「① サンプル」「② データ入力」「③④ XML生成・ダウンロード」です。

## 技術スタック

- **フレームワーク**: Next.js 16 (App Router)
- **言語**: TypeScript
- **UI**: shadcn/ui + Tailwind CSS v4
- **バリデーション**: zod
- **XML生成**: xmlbuilder2
- **テスト**: Vitest

## デプロイ（GitHub Pages）

### 方法A: プッシュで自動ビルド・デプロイ（推奨）

1. **Settings** → **Pages** で **Source** を **GitHub Actions** に設定する。
2. `main` ブランチへプッシュすると、ワークフローがテスト・ビルド・デプロイし、数分後に https://kmh-no3.github.io/emc-notice-genkit/ に反映される。

### 方法B: 手動デプロイ（Deploy from a branch）

1. **Settings** → **Pages** で **Source** を **Deploy from a branch**、**Branch** を `gh-pages`、**Folder** を `/ (root)` に設定する。
2. ローカルで `npm install` のあと、`npm run deploy` を実行する。

## 使用方法

### 1. サンプル（プリセット）

「① サンプル」アコーディオンを開き、プリセットを選択します。

- **最小必須1件サンプル**: 最小限のフィールドを含む1明細のサンプル（記録番号は `sample`）
- **複数明細サンプル（3件）**: 3明細を含むサンプル（記録番号は `sample-1`〜`sample-3`、合計値計算の確認用）

### 2. データ入力

「② データ入力」アコーディオンを開き、以下を入力します。

#### ①ヘッダ情報
- **通知日**: YYYYMMDD形式（例: 20260125）

#### ②通知先情報
- **利用者番号**、**銀行/支店/口座情報**

#### ③明細情報
各明細に以下を入力：
- **通知種別**: 01〜08（01:発生記録、02:譲渡記録 等）
- **義務者情報**: 銀行/支店/口座情報
- **権利者情報**: 銀行/支店/口座情報
- **債権金額**: 1〜10桁の数字
- **支払期日**: YYYYMMDD形式
- **記録番号**: 最大20文字（サンプルでは `sample` 等）
- **電子記録年月日**: YYYYMMDD形式

#### 伝票特定補助（任意）
SAP伝票との紐付けに使用：
- **BUKRS**: 会社コード（4桁）
- **BELNR**: 伝票番号（1〜10桁、自動で10桁に左0埋め）
- **GJAHR**: 会計年度（4桁）

これらを入力すると、**依頼人Ref.No.**が自動生成されます（18桁）。

### 3. XML生成

「③④ XML生成・ダウンロード」アコーディオンを開き、「XML生成」ボタンをクリックすると、入力内容がバリデーションされ、XMLが生成されます。

### 4. ダウンロード

XML生成後、同じアコーディオン内または下に表示される「XMLプレビュー」で内容を確認し、「XMLをダウンロード」ボタンから `notice_ACR.ASG.DIV.xml` をダウンロードできます。

## SAP投入手順

1. SAP S/4HANAにログイン
2. トランザクションコード `EMC_JP`（レポート: RFFOJP_EMC）を起動
3. 「受信DMEファイル」ブロックで **PCから読み込み** を選択
4. ダウンロードしたXMLファイルを指定
5. 実行してログを確認
6. FI伝票（FB03等）で `BSEG-SGTXT` フィールドが `kiroku_no` に更新されているか確認

## データ仕様

### 自動フォーマット

以下のフィールドは自動的にフォーマットされます：

- **口座番号**: 7桁に左0埋め（例: `1` → `0000001`）
- **伝票番号**: 10桁に左0埋め（例: `123456` → `0000123456`）
- **明細件数（sum_num）**: 6桁に左0埋め
- **合計金額（sum_amnt）**: 12桁に左0埋め

### バリデーション規則

- **日付**: YYYYMMDD形式の8桁数字
- **銀行コード**: 4桁数字
- **支店コード**: 3桁数字
- **口座番号**: 1〜7桁数字
- **金額**: 1〜10桁数字
- **記録番号**: 最大20文字
- **依頼人Ref.No.**: 最大40文字

## 注意事項

### セキュリティ

- このツールはブラウザ上で完結し、サーバーにデータを送信しません
- 入力データはブラウザのローカルストレージに保存されます
- **実際の顧客情報や機密情報を入力しないでください**
- テスト用のダミーデータのみを使用してください

### 制限事項

- 対応業務識別ID: `notice_ACR.ASG.DIV`（発生・譲渡通知）のみ
- 文字コード: UTF-8のみ対応（Shift_JISは将来拡張予定）
- SAPへの自動投入機能はありません（手動でEMC_JPに投入してください）

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 参考資料

- [でんさい標準フォーマット XML ver1.3 仕様書（PDF）](https://www.densai.net/pdf/hyoujyunformat_XML_ver1.3_120717.pdf)
- SAP S/4HANA 日本EMC関連ドキュメント

## 貢献・サポート

バグ報告や機能要望は、[GitHubのIssues](https://github.com/kmh-no3/emc-notice-genkit/issues)で受け付けています。
